<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of GetSolveFile</title>
  <meta name="keywords" content="GetSolveFile">
  <meta name="description" content="% solve_file = GetSolveFile(model,studyinfo,options)">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
  <script type="text/javascript">
    if (top.frames.length == 0) { top.location = "../index.html"; };
  </script>
</head>
<body>
<a name="_top"></a>
<!-- menu.html functions -->
<h1>GetSolveFile
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>% solve_file = GetSolveFile(model,studyinfo,options)</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function solve_file = GetSolveFile(model,studyinfo,varargin) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment">% solve_file = GetSolveFile(model,studyinfo,options)
 Purpose: helper function that creates or retrieves the desired solver file.
 Inputs:
   model - DynaSim model structure (see GenerateModel)
   studyinfo (optional) - DynaSim studyinfo structure (see CheckStudyinfo)
   options (optional) - cell array of key/value pairs or Matlab structure with options
     'solver'      : solver for numerical integration (see GetSolveFile)
                     {'euler','rk2','rk4'} (default: 'rk4')
     'disk_flag'     : whether to write to disk during simulation instead of storing in memory {0 or 1} (default: 0)
     'study_dir'     : relative or absolute path to output directory (default: current directory)
     'verbose_flag'  : whether to display informative messages/logs (default: 0)
 
 Output:
   solver_file - full file name of file solving the system in model
 
 See also: <a href="WriteDynaSimSolver.html" class="code" title="function [outfile,options]=WriteDynaSimSolver(model,varargin)">WriteDynaSimSolver</a>, <a href="CompareSolveFiles.html" class="code" title="function solve_file_m=CompareSolveFiles(solve_file_m)">CompareSolveFiles</a>, <a href="PrepareMEX.html" class="code" title="function mexfile=PrepareMEX(file)">PrepareMEX</a>,
           <a href="SimulateModel.html" class="code" title="function [data,studyinfo]=SimulateModel(model,varargin)">SimulateModel</a>, <a href="CreateBatch.html" class="code" title="function studyinfo=CreateBatch(base_model,modifications_set,varargin)">CreateBatch</a></pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="CheckOptions.html" class="code" title="function parms = CheckOptions(options, options_schema, strict)">CheckOptions</a>	CHECKOPTIONS - organize key/value pairs in structure with default or user-supplied values according to a schema</li><li><a href="CompareSolveFiles.html" class="code" title="function solve_file_m=CompareSolveFiles(solve_file_m)">CompareSolveFiles</a>	Purpose: look for an equivalent file in same directory</li><li><a href="Options2Keyval.html" class="code" title="function keyval = Options2Keyval(options)">Options2Keyval</a>	keyvals = Options2Keyval(options)</li><li><a href="PrepareMEX.html" class="code" title="function mexfile=PrepareMEX(file)">PrepareMEX</a>	Purpose: take a solver m-file and compile it using the Matlab coder.</li><li><a href="WriteDynaSimSolver.html" class="code" title="function [outfile,options]=WriteDynaSimSolver(model,varargin)">WriteDynaSimSolver</a>	% solver_file=WriteDynaSimSolver(model,varargin)</li><li><a href="WriteMatlabSolver.html" class="code" title="function data=WriteMatlabSolver(model,varargin)">WriteMatlabSolver</a>	% outfile=WriteMatlabSolver(model,varargin)</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="CreateBatch.html" class="code" title="function studyinfo=CreateBatch(base_model,modifications_set,varargin)">CreateBatch</a>	% studyinfo=CreateBatch(model,varargin)</li><li><a href="SimulateModel.html" class="code" title="function [data,studyinfo]=SimulateModel(model,varargin)">SimulateModel</a>	% data=SimulateModel(model,'option',value,...)</li></ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function solve_file = GetSolveFile(model,studyinfo,varargin)</a>
0002 <span class="comment">%% solve_file = GetSolveFile(model,studyinfo,options)</span>
0003 <span class="comment">% Purpose: helper function that creates or retrieves the desired solver file.</span>
0004 <span class="comment">% Inputs:</span>
0005 <span class="comment">%   model - DynaSim model structure (see GenerateModel)</span>
0006 <span class="comment">%   studyinfo (optional) - DynaSim studyinfo structure (see CheckStudyinfo)</span>
0007 <span class="comment">%   options (optional) - cell array of key/value pairs or Matlab structure with options</span>
0008 <span class="comment">%     'solver'      : solver for numerical integration (see GetSolveFile)</span>
0009 <span class="comment">%                     {'euler','rk2','rk4'} (default: 'rk4')</span>
0010 <span class="comment">%     'disk_flag'     : whether to write to disk during simulation instead of storing in memory {0 or 1} (default: 0)</span>
0011 <span class="comment">%     'study_dir'     : relative or absolute path to output directory (default: current directory)</span>
0012 <span class="comment">%     'verbose_flag'  : whether to display informative messages/logs (default: 0)</span>
0013 <span class="comment">%</span>
0014 <span class="comment">% Output:</span>
0015 <span class="comment">%   solver_file - full file name of file solving the system in model</span>
0016 <span class="comment">%</span>
0017 <span class="comment">% See also: WriteDynaSimSolver, CompareSolveFiles, PrepareMEX,</span>
0018 <span class="comment">%           SimulateModel, CreateBatch</span>
0019 
0020 <span class="comment">% Check inputs</span>
0021 opts=[];
0022 <span class="keyword">if</span> nargin&lt;1
0023   error(<span class="string">'first argument must be a DynaSim model structure.'</span>);
0024 <span class="keyword">end</span>
0025 <span class="keyword">if</span> nargin&lt;2
0026   studyinfo=[];
0027 <span class="keyword">end</span>
0028 <span class="keyword">if</span> nargin&lt;3
0029   varargin={};
0030 <span class="keyword">elseif</span> isstruct(varargin{1}) <span class="comment">% user provided an options structure</span>
0031   opts=varargin{1};
0032   fields=fieldnames(opts);
0033   varargin={};
0034 <span class="keyword">end</span>
0035 options=<a href="CheckOptions.html" class="code" title="function parms = CheckOptions(options, options_schema, strict)">CheckOptions</a>(varargin,{<span class="keyword">...</span>
0036   <span class="string">'solver'</span>,<span class="string">'rk4'</span>,{<span class="string">'euler'</span>,<span class="string">'rk1'</span>,<span class="string">'rk2'</span>,<span class="string">'rk4'</span>,<span class="string">'modified_euler'</span>,<span class="string">'rungekutta'</span>,<span class="string">'rk'</span>,<span class="string">'ode23'</span>,<span class="string">'ode45'</span>},<span class="keyword">...</span><span class="comment"> % DynaSim and built-in Matlab solvers</span>
0037   <span class="string">'matlab_solver_options'</span>,[],[],<span class="keyword">...</span><span class="comment"> % options from odeset for use with built-in Matlab solvers</span>
0038   <span class="string">'disk_flag'</span>,0,{0,1},<span class="keyword">...</span><span class="comment">            % whether to write to disk during simulation instead of storing in memory</span>
0039   <span class="string">'solve_file'</span>,[],[],<span class="keyword">...</span><span class="comment"> % m- or mex-file solving the system</span>
0040   <span class="string">'study_dir'</span>,[],[],<span class="keyword">...</span><span class="comment"> % study directory</span>
0041   <span class="string">'verbose_flag'</span>,0,{0,1},<span class="keyword">...</span>
0042   <span class="string">'parallel_flag'</span>,0,{0,1},<span class="keyword">...</span><span class="comment">     % whether to run simulations in parallel (using parfor)</span>
0043   <span class="string">'compile_flag'</span>,0,{0,1},<span class="keyword">...</span><span class="comment"> % exist('codegen')==6, whether to compile using coder instead of interpreting Matlab  </span>
0044   },false);
0045 <span class="keyword">if</span> ~isempty(opts)
0046   <span class="comment">% combine default options and user-supplied options w/ the latter</span>
0047   <span class="comment">% overriding the former</span>
0048   warning(<span class="string">'off'</span>,<span class="string">'catstruct:DuplicatesFound'</span>);
0049   options=catstruct(options,opts);
0050   options=orderfields(options,fields);
0051 <span class="keyword">end</span>
0052 
0053 <span class="keyword">if</span> options.verbose_flag
0054   fprintf(<span class="string">'PREPARING SOLVER:\n'</span>);
0055 <span class="keyword">end</span>
0056 
0057 <span class="comment">% check solver options</span>
0058 <span class="keyword">switch</span> options.solver
0059   <span class="keyword">case</span> {<span class="string">'euler'</span>,<span class="string">'rk1'</span>,<span class="string">'rk2'</span>,<span class="string">'modified_euler'</span>,<span class="string">'rk4'</span>,<span class="string">'rungekutta'</span>,<span class="string">'rk'</span>}
0060     solver_type = <span class="string">'dynasim'</span>;
0061     <span class="keyword">if</span> ~isempty(options.matlab_solver_options)
0062       warning(<span class="string">'matlab_solver_options are not used by DynaSim solvers. instead try ''ode23'' or ''ode45'' to use those options.'</span>);
0063     <span class="keyword">end</span>
0064   <span class="keyword">case</span> {<span class="string">'ode23'</span>,<span class="string">'ode45'</span>} <span class="comment">% note: only ode23 and ode45 are supported by codegen (see: http://www.mathworks.com/help/coder/ug/functions-supported-for-code-generation--alphabetical-list.html)</span>
0065     solver_type = <span class="string">'matlab'</span>;
0066     <span class="keyword">if</span> options.disk_flag==1
0067       warning(<span class="string">'using disk for real-time storage instead of memory is only available for DynaSim solvers. try using ''euler'',''rk2'', or ''rk4'' for real-time disk usage.'</span>);
0068     <span class="keyword">end</span>
0069   <span class="keyword">otherwise</span>
0070     error(<span class="string">'unrecognized solver type'</span>);
0071 <span class="keyword">end</span>
0072 
0073 <span class="keyword">if</span> ~isempty(options.solve_file)
0074   <span class="comment">% use user-provided solve_file</span>
0075   solve_file=options.solve_file;
0076   <span class="comment">% note: options.solve_file is used by cluster sim jobs (see CreateBatch())</span>
0077 <span class="keyword">elseif</span> isfield(studyinfo,<span class="string">'solve_file'</span>)
0078   <span class="comment">% use study-associated solve_file</span>
0079   solve_file=studyinfo.solve_file;
0080 <span class="keyword">else</span>
0081   <span class="comment">% set default solve_file name</span>
0082   solve_file=[<span class="string">'solve_ode_'</span> datestr(now,<span class="string">'yyyymmddHHMMSS_FFF'</span>) <span class="string">'.m'</span>];
0083 <span class="keyword">end</span>
0084 [fpath,fname,fext]=fileparts(solve_file);
0085 <span class="keyword">if</span> isempty(fpath)
0086   <span class="comment">% add path to solve_file name</span>
0087   <span class="keyword">if</span> ~isempty(options.sim_id)
0088     solve_file=fullfile(options.study_dir,<span class="string">'solve'</span>,[<span class="string">'sim'</span> num2str(options.sim_id)],[fname fext]);
0089   <span class="keyword">else</span>
0090     solve_file=fullfile(options.study_dir,<span class="string">'solve'</span>,[fname fext]);
0091   <span class="keyword">end</span>
0092   <span class="comment">% convert relative path to absolute path</span>
0093   <span class="keyword">if</span> ~strcmp(<span class="string">'/'</span>,solve_file(1)) &amp;&amp; ~strcmp(<span class="string">'\'</span>,solve_file(1))
0094     solve_file=fullfile(pwd,solve_file);
0095   <span class="keyword">end</span>
0096 <span class="keyword">end</span>
0097 [fpath,fname,fext]=fileparts(solve_file);
0098 <span class="comment">% check that solve file name is less than max function name allwoed by matlab</span>
0099 <span class="keyword">if</span> length(fname)&gt;(63-4) <span class="comment">% subtract 4 to allow suffix '_mex'</span>
0100   fname=fname(1:(63-4));
0101   solve_file=fullfile(fpath,[fname fext]);
0102 <span class="keyword">end</span>
0103 <span class="comment">% create directory for solve_file if it doesn't exist</span>
0104 <span class="keyword">if</span> ~isdir(fpath)
0105   <span class="keyword">if</span> options.verbose_flag
0106     fprintf(<span class="string">'creating solver directory %s\n'</span>,fpath);
0107   <span class="keyword">end</span>
0108   mkdir(fpath);
0109 <span class="keyword">end</span>
0110 cwd=pwd;
0111 <span class="keyword">if</span> ~strcmp(cwd,fpath)
0112   <span class="keyword">if</span> options.verbose_flag
0113     fprintf(<span class="string">'changing directory to %s\n'</span>,fpath);
0114   <span class="keyword">end</span>
0115   cd(fpath);
0116 <span class="keyword">end</span>
0117 <span class="comment">% create solve_file if it doesn't exist</span>
0118 <span class="keyword">if</span> ~exist(solve_file,<span class="string">'file'</span>)
0119   keyvals = <a href="Options2Keyval.html" class="code" title="function keyval = Options2Keyval(options)">Options2Keyval</a>(options);
0120   <span class="keyword">switch</span> solver_type
0121     <span class="keyword">case</span> <span class="string">'dynasim'</span>  <span class="comment">% write DynaSim solver function (solve_ode.m)</span>
0122       solve_file_m = <a href="WriteDynaSimSolver.html" class="code" title="function [outfile,options]=WriteDynaSimSolver(model,varargin)">WriteDynaSimSolver</a>(model,keyvals{:},<span class="string">'filename'</span>,solve_file); <span class="comment">% create DynaSim solver m-file</span>
0123     <span class="keyword">case</span> <span class="string">'matlab'</span> <span class="comment">% prepare model function handle etc for built-in solver (@odefun)</span>
0124       solve_file_m = <a href="WriteMatlabSolver.html" class="code" title="function data=WriteMatlabSolver(model,varargin)">WriteMatlabSolver</a>(model,keyvals{:},<span class="string">'filename'</span>,solve_file); <span class="comment">% create Matlab solver m-file</span>
0125                 <span class="comment">% design: WriteMatlabSolver should be very similar to</span>
0126                 <span class="comment">% WriteDynaSimSolver except have a subfunction with an odefun</span>
0127                 <span class="comment">% format variation and main function that calls odeset and</span>
0128                 <span class="comment">% feval.</span>
0129                 <span class="comment">% DynaSimToOdefun(): a function called outside of</span>
0130                 <span class="comment">% SimulateModel. it should evaluate fixed_variables and</span>
0131                 <span class="comment">% return @odefun with all substitutions. SimulateModel</span>
0132                 <span class="comment">% should be able to handle: SimulateModel(@odefun,'tspan',tspan,'ic',ic)</span>
0133   <span class="keyword">end</span>
0134   solve_file=<a href="CompareSolveFiles.html" class="code" title="function solve_file_m=CompareSolveFiles(solve_file_m)">CompareSolveFiles</a>(solve_file_m);
0135 <span class="keyword">else</span>
0136   <span class="keyword">if</span> options.verbose_flag
0137     fprintf(<span class="string">'using previous solver file: %s\n'</span>,solve_file);
0138   <span class="keyword">end</span>      
0139 <span class="keyword">end</span>
0140 <span class="comment">% create MEX file if desired and doesn't exist</span>
0141 [fpath,fname,fext]=fileparts(solve_file);
0142 solve_file_mex=fullfile(fpath,[fname <span class="string">'_mex'</span>]);
0143 <span class="keyword">if</span> options.compile_flag <span class="comment">% compile solver function</span>
0144   <span class="keyword">if</span> ~exist(solve_file_mex,<span class="string">'file'</span>)
0145     <span class="keyword">if</span> options.verbose_flag
0146       fprintf(<span class="string">'compiling solver file: %s\n'</span>,solve_file_mex);
0147     <span class="keyword">end</span>
0148     compile_start_time=tic;
0149     <a href="PrepareMEX.html" class="code" title="function mexfile=PrepareMEX(file)">PrepareMEX</a>(solve_file); <span class="comment">% mex-file solver</span>
0150     <span class="keyword">if</span> options.verbose_flag
0151       fprintf(<span class="string">'\tMEX generation complete!\n\tElapsed time: %g seconds.\n'</span>,toc(compile_start_time));
0152       <span class="comment">%toc;</span>
0153     <span class="keyword">end</span>
0154     codemex_dir=fullfile(fileparts(solve_file_mex),<span class="string">'codemex'</span>);
0155     <span class="keyword">if</span> exist(codemex_dir,<span class="string">'dir'</span>)
0156       <span class="keyword">if</span> options.verbose_flag
0157         fprintf(<span class="string">'\tremoving temporary codemex directory: %s\n'</span>,codemex_dir);
0158       <span class="keyword">end</span>
0159       rmdir(codemex_dir,<span class="string">'s'</span>);
0160     <span class="keyword">end</span>
0161   <span class="keyword">else</span>
0162     <span class="keyword">if</span> options.verbose_flag
0163       fprintf(<span class="string">'using previous compiled solver file: %s\n'</span>,solve_file_mex);
0164     <span class="keyword">end</span>
0165   <span class="keyword">end</span>
0166   solve_file=solve_file_mex;
0167 <span class="keyword">end</span>
0168 <span class="keyword">if</span> ~strcmp(cwd,fpath)
0169   <span class="keyword">if</span> options.verbose_flag
0170     fprintf(<span class="string">'changing directory back to %s\n'</span>,cwd);
0171   <span class="keyword">end</span>
0172   cd(cwd);
0173 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Fri 24-Feb-2017 14:46:35 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" target="_parent">m2html</a></strong> &copy; 2005</address>
</body>
</html>