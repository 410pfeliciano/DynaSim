<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of ApplyModifications</title>
  <meta name="keywords" content="ApplyModifications">
  <meta name="description" content="APPLYMODIFICATIONS - Apply modifications to DynaSim specification or model structure">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
  <script type="text/javascript">
    if (top.frames.length == 0) { top.location = "../index.html"; };
  </script>
</head>
<body>
<a name="_top"></a>
<!-- menu.html functions -->
<h1>ApplyModifications
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>APPLYMODIFICATIONS - Apply modifications to DynaSim specification or model structure</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function [output,modifications]=ApplyModifications(model,modifications) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment">APPLYMODIFICATIONS - Apply modifications to DynaSim specification or model structure

 ApplyModifications returns the same kind of structure with
 modifications applied. In all cases it first modifies the specification
 (model.specification if input is a model structure). Then it returns
 the modified specification or regenerates the model using the new
 specification.

 Inputs:
   - model: DynaSim model or specification structure
     - see CheckModel and CheckSpecification for details
   - modifications: modifications to make to specification structure
       {X,Y,Z; X,Y,Z; ...}
       X = population name or connection source-&gt;target
       Y = thing to modify ('name', 'size', or parameter name)
       set Y=Z if Y = name, size, or value
       Note: (X1,X2) or (Y1,Y2): modify these simultaneously in the same way

 Outputs:
   - TODO

 Examples:
 - modifying population size and parameters:
     modifications={'E','size',5; 'E','gNa',120};
     model=ApplyModifications(model,modifications);

 - modifying mechanism_list:
     m=ApplyModifications('dv/dt=10+@current; {iNa,iK}',...
                          {'pop1','mechanism_list','-iNa'});
     m.populations.mechanism_list
     m=ApplyModifications('dv/dt=10+@current; {iNa,iK}',...
                          {'pop1','mechanism_list','+iCa'});
     m.populations.mechanism_list
     m=ApplyModifications('dv/dt=10+@current; {iNa,iK}',...
                          {'pop1','mechanism_list','+(iCa,iCan,CaBuffer)'});
     m.populations.mechanism_list

 - modifying equations (using special &quot;cat()&quot; operator or direct substitution)
     m=ApplyModifications('dv/dt=10+@current; {iNa,iK}',...
                          {'pop1','equations','cat(dv/dt,+I)'});
     m.populations.equations
     m=ApplyModifications('dv/dt=I(t)+@current; I(t)=10; {iNa,iK}',...
                          {'pop1','equations','cat(I(t),+sin(2*pi*t))'});
     m.populations.equations
     m=ApplyModifications('dv/dt=I(t)+@current; I(t)=10; {iNa,iK}',...
                          {'pop1','equations','dv/dt=10+@current'});
     m.populations.equations
     m.populations.mechanism_list

 - modifying equations with reserved keywords &quot;ODEn&quot; and &quot;FUNCTIONn&quot;
   - Note:
     'ODEn' = reserved keyword referencing the n-th ODE in equations
     'ODE' = aliases ODE1
     similarly: 'FUNCTIONn' and 'FUNCTION'

     m=ApplyModifications('dv/dt=10+@current; {iNa,iK}',...
                          {'pop1','equations','cat(ODE,+I)'});
     m.populations.equations
     m=ApplyModifications('dv/dt=10+@current; du/dt=-u; {iNa,iK}',...
                          {'pop1','equations','cat(ODE2,+I)'});
     m.populations.equations
     m=ApplyModifications('dv/dt=I(t)+@current; I(t)=10; {iNa,iK}',...
                          {'pop1','equations','cat(FUNCTION,+sin(2*pi*t))'});
     m.populations.equations

 See also: <a href="GenerateModel.html" class="code" title="function [model,name_map]=GenerateModel(specification,varargin)">GenerateModel</a>, <a href="SimulateModel.html" class="code" title="function [data,studyinfo]=SimulateModel(model,varargin)">SimulateModel</a>, <a href="Vary2Modifications.html" class="code" title="function modifications_set = Vary2Modifications(vary,model)">Vary2Modifications</a></pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="CheckSpecification.html" class="code" title="function spec=CheckSpecification(specification)">CheckSpecification</a>	CHECKSPECIFICATION - standardize specification structure and auto-populate missing fields</li><li><a href="GenerateModel.html" class="code" title="function [model,name_map]=GenerateModel(specification,varargin)">GenerateModel</a>	% [model,name_map]=GenerateModel(specification,'option',value,...)</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="GenerateModel.html" class="code" title="function [model,name_map]=GenerateModel(specification,varargin)">GenerateModel</a>	% [model,name_map]=GenerateModel(specification,'option',value,...)</li><li><a href="ProbeCellProperties.html" class="code" title="function data = ProbeCellProperties(model,varargin)">ProbeCellProperties</a>	data = ProbeCellProperties(model,'option1',option1,...)</li><li><a href="ProbeFI.html" class="code" title="function data=ProbeFI(model,varargin)">ProbeFI</a>	% data=ProbeFI(model,varargin)</li><li><a href="SimulateModel.html" class="code" title="function [data,studyinfo]=SimulateModel(model,varargin)">SimulateModel</a>	% data=SimulateModel(model,'option',value,...)</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="#_sub1" class="code">function modifications=standardize_modifications(modifications,specification)</a></li><li><a href="#_sub2" class="code">function spec=modify_specification(spec,mods)</a></li><li><a href="#_sub3" class="code">function modifications=backward_compatibility(modifications)</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [output,modifications]=ApplyModifications(model,modifications)</a>
0002 <span class="comment">%APPLYMODIFICATIONS - Apply modifications to DynaSim specification or model structure</span>
0003 <span class="comment">%</span>
0004 <span class="comment">% ApplyModifications returns the same kind of structure with</span>
0005 <span class="comment">% modifications applied. In all cases it first modifies the specification</span>
0006 <span class="comment">% (model.specification if input is a model structure). Then it returns</span>
0007 <span class="comment">% the modified specification or regenerates the model using the new</span>
0008 <span class="comment">% specification.</span>
0009 <span class="comment">%</span>
0010 <span class="comment">% Inputs:</span>
0011 <span class="comment">%   - model: DynaSim model or specification structure</span>
0012 <span class="comment">%     - see CheckModel and CheckSpecification for details</span>
0013 <span class="comment">%   - modifications: modifications to make to specification structure</span>
0014 <span class="comment">%       {X,Y,Z; X,Y,Z; ...}</span>
0015 <span class="comment">%       X = population name or connection source-&gt;target</span>
0016 <span class="comment">%       Y = thing to modify ('name', 'size', or parameter name)</span>
0017 <span class="comment">%       set Y=Z if Y = name, size, or value</span>
0018 <span class="comment">%       Note: (X1,X2) or (Y1,Y2): modify these simultaneously in the same way</span>
0019 <span class="comment">%</span>
0020 <span class="comment">% Outputs:</span>
0021 <span class="comment">%   - TODO</span>
0022 <span class="comment">%</span>
0023 <span class="comment">% Examples:</span>
0024 <span class="comment">% - modifying population size and parameters:</span>
0025 <span class="comment">%     modifications={'E','size',5; 'E','gNa',120};</span>
0026 <span class="comment">%     model=ApplyModifications(model,modifications);</span>
0027 <span class="comment">%</span>
0028 <span class="comment">% - modifying mechanism_list:</span>
0029 <span class="comment">%     m=ApplyModifications('dv/dt=10+@current; {iNa,iK}',...</span>
0030 <span class="comment">%                          {'pop1','mechanism_list','-iNa'});</span>
0031 <span class="comment">%     m.populations.mechanism_list</span>
0032 <span class="comment">%     m=ApplyModifications('dv/dt=10+@current; {iNa,iK}',...</span>
0033 <span class="comment">%                          {'pop1','mechanism_list','+iCa'});</span>
0034 <span class="comment">%     m.populations.mechanism_list</span>
0035 <span class="comment">%     m=ApplyModifications('dv/dt=10+@current; {iNa,iK}',...</span>
0036 <span class="comment">%                          {'pop1','mechanism_list','+(iCa,iCan,CaBuffer)'});</span>
0037 <span class="comment">%     m.populations.mechanism_list</span>
0038 <span class="comment">%</span>
0039 <span class="comment">% - modifying equations (using special &quot;cat()&quot; operator or direct substitution)</span>
0040 <span class="comment">%     m=ApplyModifications('dv/dt=10+@current; {iNa,iK}',...</span>
0041 <span class="comment">%                          {'pop1','equations','cat(dv/dt,+I)'});</span>
0042 <span class="comment">%     m.populations.equations</span>
0043 <span class="comment">%     m=ApplyModifications('dv/dt=I(t)+@current; I(t)=10; {iNa,iK}',...</span>
0044 <span class="comment">%                          {'pop1','equations','cat(I(t),+sin(2*pi*t))'});</span>
0045 <span class="comment">%     m.populations.equations</span>
0046 <span class="comment">%     m=ApplyModifications('dv/dt=I(t)+@current; I(t)=10; {iNa,iK}',...</span>
0047 <span class="comment">%                          {'pop1','equations','dv/dt=10+@current'});</span>
0048 <span class="comment">%     m.populations.equations</span>
0049 <span class="comment">%     m.populations.mechanism_list</span>
0050 <span class="comment">%</span>
0051 <span class="comment">% - modifying equations with reserved keywords &quot;ODEn&quot; and &quot;FUNCTIONn&quot;</span>
0052 <span class="comment">%   - Note:</span>
0053 <span class="comment">%     'ODEn' = reserved keyword referencing the n-th ODE in equations</span>
0054 <span class="comment">%     'ODE' = aliases ODE1</span>
0055 <span class="comment">%     similarly: 'FUNCTIONn' and 'FUNCTION'</span>
0056 <span class="comment">%</span>
0057 <span class="comment">%     m=ApplyModifications('dv/dt=10+@current; {iNa,iK}',...</span>
0058 <span class="comment">%                          {'pop1','equations','cat(ODE,+I)'});</span>
0059 <span class="comment">%     m.populations.equations</span>
0060 <span class="comment">%     m=ApplyModifications('dv/dt=10+@current; du/dt=-u; {iNa,iK}',...</span>
0061 <span class="comment">%                          {'pop1','equations','cat(ODE2,+I)'});</span>
0062 <span class="comment">%     m.populations.equations</span>
0063 <span class="comment">%     m=ApplyModifications('dv/dt=I(t)+@current; I(t)=10; {iNa,iK}',...</span>
0064 <span class="comment">%                          {'pop1','equations','cat(FUNCTION,+sin(2*pi*t))'});</span>
0065 <span class="comment">%     m.populations.equations</span>
0066 <span class="comment">%</span>
0067 <span class="comment">% See also: GenerateModel, SimulateModel, Vary2Modifications</span>
0068 
0069 <span class="comment">% check for modifications</span>
0070 <span class="keyword">if</span> isempty(modifications)
0071   <span class="comment">% nothing to do</span>
0072   output=model;
0073   <span class="keyword">return</span>;
0074 <span class="keyword">end</span>
0075 
0076 <span class="comment">% check input type</span>
0077 <span class="keyword">if</span> ~isfield(model,<span class="string">'state_variables'</span>)
0078   ismodel=0;
0079 <span class="keyword">else</span>
0080   ismodel=1;
0081 <span class="keyword">end</span>
0082 <span class="comment">% check specification</span>
0083 <span class="keyword">if</span> ismodel
0084   specification=<a href="CheckSpecification.html" class="code" title="function spec=CheckSpecification(specification)">CheckSpecification</a>(model.specification);
0085 <span class="keyword">else</span>
0086   specification=<a href="CheckSpecification.html" class="code" title="function spec=CheckSpecification(specification)">CheckSpecification</a>(model);
0087 <span class="keyword">end</span>
0088 
0089 <span class="comment">% update specification with whatever is in modifications</span>
0090 modifications=<a href="#_sub1" class="code" title="subfunction modifications=standardize_modifications(modifications,specification)">standardize_modifications</a>(modifications,specification);
0091 specification=<a href="#_sub2" class="code" title="subfunction spec=modify_specification(spec,mods)">modify_specification</a>(specification,modifications);
0092 
0093 <span class="comment">% update model if input was a model structure</span>
0094 <span class="keyword">if</span> ismodel
0095   output=<a href="GenerateModel.html" class="code" title="function [model,name_map]=GenerateModel(specification,varargin)">GenerateModel</a>(specification);
0096 <span class="keyword">else</span>
0097   output=specification;
0098 <span class="keyword">end</span>
0099 
0100 <a name="_sub1" href="#_subfunctions" class="code">function modifications=standardize_modifications(modifications,specification)</a>
0101 <span class="comment">% convert all modifications into 3-column cell matrix format</span>
0102 <span class="comment">% (namespace,variable,value)</span>
0103 
0104 <span class="comment">% 1. modifications structure</span>
0105 <span class="comment">% 2. partial specification structure</span>
0106 
0107 <span class="keyword">if</span> isstruct(modifications)
0108   <span class="comment">% convert structure to cell matrix</span>
0109   <span class="comment">% ...</span>
0110 <span class="keyword">end</span>
0111 
0112 <span class="comment">% check backward compatibility</span>
0113 modifications=<a href="#_sub3" class="code" title="subfunction modifications=backward_compatibility(modifications)">backward_compatibility</a>(modifications);
0114 
0115 <span class="comment">% check for empty object specification</span>
0116 missing_objects=find(cellfun(@isempty,modifications(:,1)));
0117 <span class="keyword">if</span> any(missing_objects)
0118   <span class="comment">% set to default population name</span>
0119   <span class="keyword">for</span> i=1:length(missing_objects)
0120     modifications{missing_objects(i),1}=specification.populations(1).name;<span class="comment">%'pop1';</span>
0121   <span class="keyword">end</span>
0122 <span class="keyword">end</span>
0123 
0124 <span class="comment">% support modifying multiple elements (of namespace or variable) simultaneously</span>
0125 <span class="comment">% approach -- add extra entry for each thing to modify</span>
0126 <span class="comment">% eg) expand {'(E,I)','Cm',2} to {'E','Cm',2; 'I','Cm',2}</span>
0127 <span class="comment">% note: should be able to support {'(E,I)','(EK,EK2)',-80}</span>
0128 <span class="keyword">if</span> any(~cellfun(@isempty,regexp(modifications(:,1),<span class="string">'^\(.*\)$'</span>))) || <span class="keyword">...</span>
0129    any(~cellfun(@isempty,regexp(modifications(:,2),<span class="string">'^\(.*\)$'</span>)))
0130   <span class="comment">% loop over modifications</span>
0131   modifications_={};
0132   <span class="keyword">for</span> i=1:size(modifications,1)
0133     <span class="comment">% check namespace for ()</span>
0134     namespaces=regexp(modifications{i,1},<span class="string">'[\w\.\-&lt;&gt;]+'</span>,<span class="string">'match'</span>);
0135     <span class="comment">% check variable for ()</span>
0136     variables=regexp(modifications{i,2},<span class="string">'[\w\.-]+'</span>,<span class="string">'match'</span>);
0137     <span class="comment">% check size of values matches number of namespaces, variables</span>
0138     <span class="keyword">if</span> isscalar(modifications{i,3}) <span class="comment">% in case number of values is one</span>
0139         modifications{i,3} = repmat(modifications{i,3},length(variables),length(namespaces));
0140     <span class="keyword">elseif</span> size(modifications{i,3},1) ~= length(variables) || size(modifications{i,3},2) ~= length(namespaces) 
0141         <span class="comment">% in case values is number of variables x 1</span>
0142         <span class="keyword">if</span> size(modifications{i,3},1) == length(variables) &amp;&amp; size(modifications{i,3},2) == 1
0143             modifications{i,3} = repmat(modifications{i,3},1,length(namespaces));
0144         <span class="comment">% in case values is 1 x number of namespaces</span>
0145         <span class="keyword">elseif</span> size(modifications{i,3},2) == length(namespaces) &amp;&amp; size(modifications{i,3},1) == 1
0146             modifications{i,3} = repmat(modifications{i,3},length(variables),1);
0147         <span class="keyword">else</span>
0148             error([<span class="string">'Numerical values varied over must be in array format,'</span>,<span class="keyword">...</span>
0149                 <span class="string">'where dimensions 1, 2, and 3 correspond to mechanisms, values, and populations varied over.'</span>])
0150         <span class="keyword">end</span>
0151     <span class="keyword">end</span>
0152     <span class="comment">% expand list of modifications</span>
0153     <span class="keyword">for</span> j=1:length(namespaces)
0154       <span class="keyword">for</span> k=1:length(variables)
0155         modifications_(end+1,1:3)={namespaces{j},variables{k},modifications{i,3}(k,j)};
0156       <span class="keyword">end</span>
0157     <span class="keyword">end</span>
0158   <span class="keyword">end</span>
0159   modifications=modifications_;
0160 <span class="keyword">end</span>
0161 
0162 <a name="_sub2" href="#_subfunctions" class="code">function spec=modify_specification(spec,mods)</a>
0163 precision=8; <span class="comment">% number of digits allowed for user-supplied values</span>
0164 predefined_variables={<span class="string">'name'</span>,<span class="string">'size'</span>,<span class="string">'parameters'</span>,<span class="string">'mechanism_list'</span>,<span class="string">'equations'</span>};
0165 pop_names={spec.populations.name};
0166 <span class="keyword">if</span> ~isempty(spec.connections)
0167   con_names=arrayfun(@(x)[x.source <span class="string">'-&gt;'</span> x.target],spec.connections,<span class="string">'uni'</span>,0);
0168 <span class="keyword">else</span>
0169   con_names=[];
0170 <span class="keyword">end</span>
0171 <span class="comment">% loop over modifications to apply</span>
0172 <span class="keyword">for</span> i=1:size(mods,1)
0173   obj=mods{i,1}; <span class="comment">% population name or connection source-target</span>
0174   fld=mods{i,2}; <span class="comment">% population name, size, or parameter name</span>
0175   <span class="keyword">if</span> ~ischar(obj)
0176     error(<span class="string">'modification must be applied to population name or connection source-target'</span>);
0177   <span class="keyword">end</span>
0178   <span class="keyword">if</span> ~ischar(fld) <span class="comment">%|| ~ismember(fld,{'name','size','parameters','mechanism_list','equations'})</span>
0179     error(<span class="string">'modification must be applied to population ''name'',''size'',or a parameter referenced by its name'</span>);
0180   <span class="keyword">end</span>
0181   <span class="comment">% standardize connection object: convert target&lt;-source to source-&gt;target</span>
0182   <span class="keyword">if</span> any(strfind(obj,<span class="string">'&lt;-'</span>))
0183     ind=strfind(obj,<span class="string">'&lt;-'</span>);
0184     obj=[obj(ind(1)+2:end) <span class="string">'-&gt;'</span> obj(1:ind(1)-1)];
0185   <span class="keyword">end</span>
0186   val=mods{i,3}; <span class="comment">% value for population name or size, or parameter to modify</span>
0187   <span class="keyword">if</span> ismember(obj,pop_names)
0188     type=<span class="string">'populations'</span>;
0189     names=pop_names;
0190   <span class="keyword">elseif</span> ismember(obj,con_names)
0191     type=<span class="string">'connections'</span>;
0192     names=con_names;
0193   <span class="keyword">else</span>
0194     warning(<span class="string">'name of object to modify not found in populations or connections.'</span>);
0195     <span class="keyword">continue</span>
0196   <span class="keyword">end</span>
0197   index=ismember(names,obj);
0198   <span class="keyword">if</span> strcmp(fld,<span class="string">'mechanism_list'</span>)
0199     <span class="comment">% support --</span>
0200     <span class="comment">% 'E'    'mechanism_list'    '(iNa,iK)'</span>
0201     <span class="comment">% 'E'    'mechanism_list'    '-(iNa,iK)'</span>
0202     <span class="comment">% 'E'    'mechanism_list'    '+(iK)'</span>
0203     <span class="comment">% 'E'    'mechanism_list'    '+iK'</span>
0204     <span class="comment">% 'E'    'mechanism_list'    'iK'</span>
0205     elems=regexp(val,<span class="string">'[\w@]+'</span>,<span class="string">'match'</span>);
0206     <span class="keyword">if</span> strcmp(val(1),<span class="string">'+'</span>)
0207       <span class="comment">% add mechanisms to existing list</span>
0208       spec.(type)(index).mechanism_list=unique(cat(2,spec.(type)(index).mechanism_list,elems),<span class="string">'stable'</span>);
0209     <span class="keyword">elseif</span> strcmp(val(1),<span class="string">'-'</span>)
0210       <span class="comment">% remove mechanisms from existing list</span>
0211       spec.(type)(index).mechanism_list=setdiff(spec.(type)(index).mechanism_list,elems,<span class="string">'stable'</span>);
0212     <span class="keyword">else</span>
0213       <span class="comment">% redefine mechanism list</span>
0214       spec.(type)(index).mechanism_list=elems;
0215     <span class="keyword">end</span>
0216   <span class="keyword">elseif</span> strcmp(fld,<span class="string">'equations'</span>) &amp;&amp; ~isempty(regexp(val,<span class="string">'^cat('</span>,<span class="string">'once'</span>))
0217     <span class="comment">% process special case: cat(TARGET,EXPRESSION)</span>
0218     eqns=spec.(type)(index).equations;
0219     args=regexp(val,<span class="string">'cat\((.+)\)'</span>,<span class="string">'tokens'</span>,<span class="string">'once'</span>);
0220     ind=find(args{1}==<span class="string">','</span>,1,<span class="string">'first'</span>);
0221     target=args{1}(1:ind-1);
0222     expression=args{1}(ind+1:end);
0223 <span class="comment">%     args=regexp(args{1},',','split');</span>
0224 <span class="comment">%     target=args{1};</span>
0225 <span class="comment">%     expression=args{2};</span>
0226     <span class="comment">% support keywords: ODEn, ODE=ODE1, FUNCTIONn, FUNCTION=FUNCTION1</span>
0227     <span class="keyword">if</span> strncmp(<span class="string">'ODE'</span>,target,3)
0228       <span class="comment">% support target = ODEn and ODE=ODE1</span>
0229       <span class="comment">% replace target by n-th ODE LHS</span>
0230       lines=cellfun(@strtrim,strsplit(eqns,<span class="string">';'</span>),<span class="string">'uni'</span>,0); <span class="comment">% split equations into statements</span>
0231       lines=lines(~cellfun(@isempty,lines)); <span class="comment">% eliminate empty elements</span>
0232       pattern=<span class="string">'^((\w+'')|(d\w+/dt))\s*='</span>; <span class="comment">% pattern for ODEs</span>
0233       inds=regexp(lines,pattern,<span class="string">'once'</span>); <span class="comment">% indices to ODE statements</span>
0234       inds=find(~cellfun(@isempty,inds));
0235       <span class="comment">% get index to the ODE statement to modify</span>
0236       <span class="keyword">if</span> strcmp(target,<span class="string">'ODE'</span>)
0237         ind=inds(1);
0238       <span class="keyword">else</span>
0239         n=str2num(target(4:end));
0240         ind=inds(n);
0241       <span class="keyword">end</span>
0242       <span class="comment">% get LHS of ODE</span>
0243       <span class="comment">%LHS=regexp(lines{ind},'^(.+)=','tokens','once');</span>
0244       LHS=regexp(lines{ind},<span class="string">'^([^=]+)='</span>,<span class="string">'tokens'</span>,<span class="string">'once'</span>);
0245       target=LHS{1};
0246     <span class="keyword">elseif</span> strncmp(<span class="string">'FUNCTION'</span>,target,8)
0247       <span class="comment">% support target = FUNCTIONn and FUNCTION=FUNCTION1</span>
0248       <span class="comment">% replace target by n-th FUNCTION LHS</span>
0249       lines=cellfun(@strtrim,strsplit(eqns,<span class="string">';'</span>),<span class="string">'uni'</span>,0); <span class="comment">% split equations into statements</span>
0250       lines=lines(~cellfun(@isempty,lines)); <span class="comment">% eliminate empty elements</span>
0251       pattern=<span class="string">'^\w+\([a-zA-Z][\w,]*\)\s*='</span>; <span class="comment">% pattern for functions</span>
0252       inds=regexp(lines,pattern,<span class="string">'once'</span>); <span class="comment">% indices to function statements</span>
0253       inds=find(~cellfun(@isempty,inds));
0254       <span class="comment">% get index to the function statement to modify</span>
0255       <span class="keyword">if</span> strcmp(target,<span class="string">'FUNCTION'</span>)
0256         ind=inds(1);
0257       <span class="keyword">else</span>
0258         n=str2num(target(9:end));
0259         ind=inds(n);
0260       <span class="keyword">end</span>
0261       <span class="comment">% get LHS of ODE</span>
0262       <span class="comment">%LHS=regexp(lines{ind},'^(.+)=','tokens','once');</span>
0263       LHS=regexp(lines{ind},<span class="string">'^([^=]+)='</span>,<span class="string">'tokens'</span>,<span class="string">'once'</span>);
0264       target=LHS{1};
0265     <span class="keyword">end</span>
0266     <span class="comment">% add escape character for using regular expression to match function statements</span>
0267     target=strrep(target,<span class="string">'('</span>,<span class="string">'\('</span>);
0268     target=strrep(target,<span class="string">')'</span>,<span class="string">'\)'</span>);
0269     <span class="comment">% modify equations</span>
0270     old=regexp(eqns,[target <span class="string">'\s*=[^;]+'</span>],<span class="string">'match'</span>);
0271     <span class="keyword">if</span> ~isempty(old)
0272       eqns=strrep(eqns,old{1},[old{1} expression]);
0273       spec.(type)(index).equations=eqns;
0274     <span class="keyword">end</span>    
0275   <span class="keyword">elseif</span> ismember(fld,predefined_variables) <span class="comment">% not a single parameter to modify</span>
0276     spec.(type)(index).(fld)=val;
0277     <span class="keyword">if</span> strcmp(type,<span class="string">'populations'</span>) &amp;&amp; strcmp(fld,<span class="string">'name'</span>)
0278       <span class="comment">% update name in connections</span>
0279       <span class="keyword">for</span> j=1:length(spec.connections)
0280         <span class="keyword">if</span> strcmp(pop_names{index},spec.connections(j).source)
0281           spec.connections(j).source=val;
0282         <span class="keyword">end</span>
0283         <span class="keyword">if</span> strcmp(pop_names{index},spec.connections(j).target)
0284           spec.connections(j).target=val;
0285         <span class="keyword">end</span>        
0286       <span class="keyword">end</span>
0287     <span class="keyword">end</span>    
0288   <span class="keyword">else</span> <span class="comment">% modify a single parameter in the populations.parameters cell array</span>
0289     param_names=spec.(type)(index).parameters(1:2:end);
0290     <span class="keyword">if</span> isempty(spec.(type)(index).parameters)
0291       <span class="comment">% no parameters set; start cell array of parameters</span>
0292       spec.(type)(index).parameters={fld,val};<span class="comment">%toString(val2,precision)};</span>
0293     <span class="keyword">elseif</span> ismember(fld,param_names)
0294       <span class="comment">% parameter found in list; update its value</span>
0295       val_pos=2*find(ismember(param_names,fld));
0296       spec.(type)(index).parameters{val_pos}=val;<span class="comment">%toString(val2,precision);</span>
0297     <span class="keyword">else</span>
0298       <span class="comment">% parameter not in existing list; append to end</span>
0299       spec.(type)(index).parameters{end+1}=fld;
0300       spec.(type)(index).parameters{end+1}=val;<span class="comment">%toString(val2,precision);</span>
0301     <span class="keyword">end</span>
0302   <span class="keyword">end</span>
0303 <span class="keyword">end</span>
0304 
0305 <a name="_sub3" href="#_subfunctions" class="code">function modifications=backward_compatibility(modifications)</a>
0306 <span class="comment">% convert 2-column specification to 3-column specification with empty object name</span>
0307 <span class="keyword">if</span> size(modifications,2)==2
0308   tmp={};
0309   <span class="keyword">for</span> i=1:size(modifications,1)
0310     tmp{i,1}=<span class="string">''</span>;
0311     tmp{i,2}=modifications{i,1};
0312     tmp{i,3}=modifications{i,2};
0313   <span class="keyword">end</span>
0314   modifications=tmp;
0315 <span class="keyword">end</span>
0316 <span class="comment">% convert 4-column specification to 3-column</span>
0317 <span class="keyword">if</span> size(modifications,2)==4
0318   <span class="keyword">for</span> i=1:size(modifications,1)
0319     <span class="keyword">if</span> strcmp(modifications{i,2},<span class="string">'parameters'</span>)
0320       <span class="comment">% shift parameter name to 2nd column</span>
0321       modifications{i,2}=modifications{i,3};
0322       <span class="comment">% shift parameter value to 3rd column</span>
0323       modifications{i,3}=modifications{i,4};
0324     <span class="keyword">end</span>
0325   <span class="keyword">end</span>
0326   <span class="comment">% remove fourth column</span>
0327   modifications=modifications(:,1:3);
0328 <span class="keyword">end</span>
0329 <span class="comment">% convert connection reference source-target to source-&gt;target</span>
0330 <span class="keyword">if</span> any(~cellfun(@isempty,regexp(modifications(:,1),<span class="string">'\w-\w'</span>)))
0331   <span class="comment">% find elements to adjust</span>
0332   inds=find(~cellfun(@isempty,regexp(modifications(:,1),<span class="string">'\w-\w'</span>)));
0333   <span class="keyword">for</span> i=1:length(inds)
0334     modifications{inds(i),1}=strrep(modifications{inds(i),1},<span class="string">'-'</span>,<span class="string">'-&gt;'</span>);
0335   <span class="keyword">end</span>
0336 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Fri 24-Feb-2017 14:46:35 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" target="_parent">m2html</a></strong> &copy; 2005</address>
</body>
</html>