<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of MonitorStudy</title>
  <meta name="keywords" content="MonitorStudy">
  <meta name="description" content="[studyinfo,status]=MonitorStudy(studyinfo,key/value options)">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
  <script type="text/javascript">
    if (top.frames.length == 0) { top.location = "../index.html"; };
  </script>
</head>
<body>
<a name="_top"></a>
<!-- menu.html functions -->
<h1>MonitorStudy
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>[studyinfo,status]=MonitorStudy(studyinfo,key/value options)</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function [studyinfo,study_status]=MonitorStudy(studyinfo,varargin) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment"> [studyinfo,status]=MonitorStudy(studyinfo,key/value options)
 Purpose: display information on study progress.
 inputs:
   - studyinfo: DynaSim studyinfo structure, study directory, or studyinfo MAT filename
   - options: ...
 outputs:
   - studyinfo: DynaSim studyinfo structure
   - status: numeric code
       0 (study in progress)
       1 (study finished)
       2 (error in study)
       -1 (function failed)
 
 see also: <a href="SimulateModel.html" class="code" title="function [data,studyinfo]=SimulateModel(model,varargin)">SimulateModel</a>, <a href="CreateBatch.html" class="code" title="function studyinfo=CreateBatch(base_model,modifications_set,varargin)">CreateBatch</a>, <a href="CheckStudyinfo.html" class="code" title="function studyinfo=CheckStudyinfo(studyinfo,varargin)">CheckStudyinfo</a></pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="CheckOptions.html" class="code" title="function parms = CheckOptions(options, options_schema, strict)">CheckOptions</a>	CHECKOPTIONS - organize key/value pairs in structure with default or user-supplied values according to a schema</li><li><a href="CheckStudyinfo.html" class="code" title="function studyinfo=CheckStudyinfo(studyinfo,varargin)">CheckStudyinfo</a>	CHECKSTUDYINFO - Standardize studyinfo structure and auto-populate missing fields</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="CreateBatch.html" class="code" title="function studyinfo=CreateBatch(base_model,modifications_set,varargin)">CreateBatch</a>	% studyinfo=CreateBatch(model,varargin)</li></ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [studyinfo,study_status]=MonitorStudy(studyinfo,varargin)</a>
0002 <span class="comment">% [studyinfo,status]=MonitorStudy(studyinfo,key/value options)</span>
0003 <span class="comment">% Purpose: display information on study progress.</span>
0004 <span class="comment">% inputs:</span>
0005 <span class="comment">%   - studyinfo: DynaSim studyinfo structure, study directory, or studyinfo MAT filename</span>
0006 <span class="comment">%   - options: ...</span>
0007 <span class="comment">% outputs:</span>
0008 <span class="comment">%   - studyinfo: DynaSim studyinfo structure</span>
0009 <span class="comment">%   - status: numeric code</span>
0010 <span class="comment">%       0 (study in progress)</span>
0011 <span class="comment">%       1 (study finished)</span>
0012 <span class="comment">%       2 (error in study)</span>
0013 <span class="comment">%       -1 (function failed)</span>
0014 <span class="comment">%</span>
0015 <span class="comment">% see also: SimulateModel, CreateBatch, CheckStudyinfo</span>
0016 
0017 <span class="comment">% Check inputs</span>
0018 options=<a href="CheckOptions.html" class="code" title="function parms = CheckOptions(options, options_schema, strict)">CheckOptions</a>(varargin,{<span class="keyword">...</span>
0019   <span class="string">'verbose_flag'</span>,1,{0,1},<span class="keyword">...</span>
0020   <span class="string">'process_id'</span>,[],[],<span class="keyword">...</span><span class="comment"> % process identifier for loading studyinfo if necessary</span>
0021   },false);
0022 <span class="keyword">if</span> isstruct(studyinfo) &amp;&amp; isfield(studyinfo,<span class="string">'study_dir'</span>)
0023   <span class="comment">% retrieve most up-to-date studyinfo structure from studyinfo.mat file</span>
0024   studyinfo=<a href="CheckStudyinfo.html" class="code" title="function studyinfo=CheckStudyinfo(studyinfo,varargin)">CheckStudyinfo</a>(studyinfo.study_dir,<span class="string">'process_id'</span>,options.process_id);
0025 <span class="keyword">else</span>
0026   <span class="comment">% process the provided studyinfo structure</span>
0027   studyinfo=<a href="CheckStudyinfo.html" class="code" title="function studyinfo=CheckStudyinfo(studyinfo,varargin)">CheckStudyinfo</a>(studyinfo,<span class="string">'process_id'</span>,options.process_id);
0028 <span class="keyword">end</span>
0029 
0030 <span class="comment">% Check status of study</span>
0031 <span class="keyword">if</span> all(strcmp(<span class="string">'finished'</span>,{studyinfo.simulations.status}))
0032   study_status=1; <span class="comment">% study finished</span>
0033 <span class="keyword">elseif</span> any(~cellfun(@isempty,{studyinfo.simulations.error_log}))
0034   study_status=-1; <span class="comment">% errors in study</span>
0035 <span class="keyword">else</span>
0036   study_status=0; <span class="comment">% study in progress</span>
0037 <span class="keyword">end</span>
0038 
0039 <span class="keyword">if</span> options.verbose_flag==0
0040   <span class="keyword">return</span>;
0041 <span class="keyword">end</span>
0042 
0043 fprintf(<span class="string">'-------------------------------------------------------------\n'</span>);
0044 <span class="comment">%% 1.0 Processing statistics by host (e.g., compute times)</span>
0045 <span class="comment">% get host for each simulation</span>
0046 running=find(~arrayfun(@(x)isempty(x.machine_info),studyinfo.simulations));
0047 <span class="keyword">if</span> any(running)
0048   hosts=arrayfun(@(x)x.machine_info.host_name,studyinfo.simulations(running),<span class="string">'uni'</span>,0);
0049   <span class="comment">% make list of unique hosts</span>
0050   uniq_hosts=unique(hosts);
0051   num_hosts=length(uniq_hosts);
0052   <span class="comment">% collect info for each host</span>
0053   num_simulations=zeros(1,num_hosts);
0054   num_finished=zeros(1,num_hosts);
0055   mean_duration=zeros(1,num_hosts);
0056   num_running=zeros(1,num_hosts);
0057   num_failed=zeros(1,num_hosts);
0058   num_cores=zeros(1,num_hosts);
0059   <span class="keyword">for</span> i=1:num_hosts
0060     <span class="comment">% get list of simulations on this host</span>
0061     these_sims=running(strcmp(uniq_hosts{i},hosts));
0062     <span class="comment">% store the number of simulations processed on this host</span>
0063     num_simulations(i)=length(these_sims);
0064     <span class="comment">% get list of simulations that are running on this host</span>
0065     started=strcmp(<span class="string">'started'</span>,{studyinfo.simulations(these_sims).status});
0066     num_running(i)=length(find(started));
0067     <span class="comment">% get list of simulations that have finished</span>
0068     finished=strcmp(<span class="string">'finished'</span>,{studyinfo.simulations(these_sims).status});
0069     num_finished(i)=length(find(finished));
0070     <span class="comment">% get mean duration of simulations that have finished</span>
0071     <span class="keyword">if</span> num_finished(i)&gt;0
0072       mean_duration(i)=mean([studyinfo.simulations(these_sims(finished)).duration]);
0073     <span class="keyword">else</span>
0074       mean_duration(i)=nan;
0075     <span class="keyword">end</span>
0076     <span class="comment">% get list of simulations that have failed</span>
0077     failed=strcmp(<span class="string">'failed'</span>,{studyinfo.simulations(these_sims).status});
0078     num_failed(i)=length(find(failed));
0079     <span class="comment">% tech info</span>
0080     <span class="keyword">try</span>
0081       num_cores(i)=studyinfo.simulations(these_sims(1)).machine_info.num_cores;
0082     <span class="keyword">catch</span>
0083       num_cores(i)=nan;
0084     <span class="keyword">end</span>
0085     <span class="comment">%total_memory=studyinfo.simulations(these_sims(1)).machine_info.total_memory; % string</span>
0086   <span class="keyword">end</span>
0087   <span class="comment">% sort hosts by mean_duration</span>
0088   [~,I]=sort(mean_duration,2,<span class="string">'descend'</span>);
0089   <span class="comment">% display info for each host</span>
0090   fprintf(<span class="string">'Processing statistics (hosts sorted by mean compute time T):\n'</span>);
0091   <span class="keyword">for</span> i=1:num_hosts
0092     index=I(i);
0093     fprintf(<span class="string">'  @%s (%g cores)\n'</span>,uniq_hosts{index},num_cores(index));<span class="comment">%,num_finished(index),num_simulations(index),mean_duration(index),num_failed(index),num_running(index));</span>
0094     fprintf(<span class="string">'    %g of %g sims finished (T: %gsec); %g failed; %g running.\n'</span>,num_finished(index),num_simulations(index),mean_duration(index),num_failed(index),num_running(index));
0095   <span class="keyword">end</span>
0096 <span class="keyword">end</span>
0097 
0098 <span class="comment">%% 2.0 Errors</span>
0099 <span class="comment">% get list of errors over all simulations</span>
0100 errors={studyinfo.simulations.error_log};
0101 <span class="comment">% collapse into list of unique errors</span>
0102 uniq_errors=unique(errors(cellfun(@ischar,errors)));
0103 <span class="comment">% number of unique errors</span>
0104 num_uniq_errors=length(uniq_errors);
0105 <span class="comment">% indices to simulations with errors</span>
0106 error_inds=find(~cellfun(@isempty,errors)); 
0107 <span class="keyword">if</span> options.verbose_flag
0108   <span class="comment">% Display errors for each simulation</span>
0109   <span class="keyword">if</span> any(error_inds) <span class="comment">% some sims had errors</span>
0110     fprintf(<span class="string">'Errors:\n'</span>);
0111     <span class="keyword">for</span> i=1:length(error_inds)
0112       siminfo=studyinfo.simulations(error_inds(i));
0113       <span class="keyword">if</span> strcmp(siminfo.status,<span class="string">'finished'</span>)
0114         fprintf(<span class="string">'  Simulation %g (error corrected, now %s):\n'</span>,siminfo.sim_id,siminfo.status);
0115       <span class="keyword">elseif</span> ~strcmp(siminfo.status,<span class="string">'failed'</span>)
0116         fprintf(<span class="string">'  Simulation %g (now re-%s):\n'</span>,siminfo.sim_id,siminfo.status);
0117       <span class="keyword">else</span>
0118         fprintf(<span class="string">'  Simulation %g (%s):\n'</span>,siminfo.sim_id,siminfo.status);
0119       <span class="keyword">end</span>
0120       <span class="keyword">try</span> fprintf(<span class="string">'    Host name: %s\n'</span>,siminfo.machine_info.host_name); <span class="keyword">end</span>
0121       fprintf(<span class="string">'    Start time: %s\n'</span>,siminfo.start_time);  
0122       fprintf(<span class="string">'    Error log: %s\n'</span>,siminfo.error_log);
0123     <span class="keyword">end</span>
0124   <span class="keyword">end</span>
0125 <span class="keyword">else</span>
0126   <span class="comment">% Display each unique error message only once</span>
0127   <span class="keyword">if</span> any(error_inds) <span class="comment">% some sims had errors</span>
0128     fprintf(<span class="string">'Unique Errors:\n'</span>);
0129     <span class="comment">% display each unique error message once and list the simulation IDs with</span>
0130     <span class="comment">% matching errors</span>
0131     <span class="keyword">for</span> i=1:num_uniq_errors
0132       <span class="comment">% do nothing if there is no error message</span>
0133       <span class="keyword">if</span> isempty(uniq_errors{i})
0134         <span class="keyword">continue</span>; 
0135       <span class="keyword">end</span>
0136       <span class="comment">% get list of simulations with this error</span>
0137       matches=strcmp(uniq_errors{i},errors);
0138       sim_ids=[studyinfo.simulations(matches).sim_id];
0139       fprintf(<span class="string">'  Simulation(s) %s:\n'</span>,num2str(sim_ids));
0140       fprintf(<span class="string">'    Error log: %s\n'</span>,uniq_errors{i});
0141     <span class="keyword">end</span>
0142   <span class="keyword">end</span>
0143 <span class="keyword">end</span>
0144 
0145 <span class="comment">%% 3.0 Paths</span>
0146 fprintf(<span class="string">'Paths:\n'</span>);
0147 fprintf(<span class="string">'  Study directory: %s\n'</span>,studyinfo.study_dir);
0148 <span class="keyword">if</span> ~isempty(studyinfo.paths)
0149   <span class="keyword">if</span> isfield(studyinfo.paths,<span class="string">'mechanisms'</span>) &amp;&amp; iscell(studyinfo.paths.mechanisms)
0150     <span class="keyword">if</span> length(studyinfo.paths.mechanisms)==1 <span class="comment">% print path on one line</span>
0151       fprintf(<span class="string">'  Model files:     %s\n'</span>,studyinfo.paths.mechanisms{1});
0152     <span class="keyword">else</span> <span class="comment">% print each mech path on a separate line</span>
0153       fprintf(<span class="string">'  Model files:\n'</span>);
0154       <span class="keyword">for</span> i=1:length(studyinfo.paths.mechanisms)
0155         fprintf(<span class="string">'    %s\n'</span>,studyinfo.paths.mechanisms{i});
0156       <span class="keyword">end</span>
0157     <span class="keyword">end</span>
0158   <span class="keyword">end</span>
0159   <span class="keyword">if</span> isfield(studyinfo.paths,<span class="string">'dynasim_functions'</span>)  
0160     fprintf(<span class="string">'  DynaSim functions: %s\n'</span>,studyinfo.paths.dynasim_functions);
0161   <span class="keyword">end</span>
0162   <span class="keyword">if</span> isfield(studyinfo.paths,<span class="string">'batch_dir'</span>)
0163     fprintf(<span class="string">'  Batch directory: %s\n'</span>,studyinfo.paths.batch_dir);
0164   <span class="keyword">end</span>
0165 <span class="keyword">end</span>
0166 
0167 <span class="comment">%% 4.0 Status summary</span>
0168 <span class="comment">% get status for each simulation</span>
0169 status={studyinfo.simulations.status};
0170 <span class="comment">% make list of status types</span>
0171 uniq_status=unique(status);
0172 <span class="comment">% display counts for each status type</span>
0173 fprintf(<span class="string">'Simulation status summary:\n'</span>);
0174 <span class="keyword">for</span> i=1:length(uniq_status)
0175   count=length(find(strcmp(uniq_status{i},status)));
0176   fprintf(<span class="string">'  %g %s\n'</span>,count,uniq_status{i});
0177 <span class="keyword">end</span>
0178 
0179 <span class="comment">%% notify about special cases</span>
0180 <span class="keyword">if</span> all(strcmp(<span class="string">'finished'</span>,status))
0181   fprintf(<span class="string">'**** ALL SIMULATIONS HAVE FINISHED ****\n'</span>);
0182 <span class="keyword">end</span>
0183 <span class="keyword">if</span> all(strcmp(<span class="string">'initialized'</span>,status))
0184   fprintf(<span class="string">'**** NO SIMULATIONS HAVE STARTED ****\n'</span>);
0185 <span class="keyword">end</span>
0186 <span class="keyword">if</span> all(strcmp(<span class="string">'started'</span>,status))
0187   fprintf(<span class="string">'**** ALL SIMULATIONS ARE RUNNING ****\n'</span>);
0188 <span class="keyword">end</span>
0189 <span class="keyword">if</span> all(strcmp(<span class="string">'failed'</span>,status))
0190   fprintf(<span class="string">'**** ALL SIMULATIONS FAILED ****\n'</span>);
0191 <span class="keyword">end</span>
0192 
0193 fprintf(<span class="string">'-------------------------------------------------------------\n'</span>);
0194</pre></div>
<hr><address>Generated on Fri 24-Feb-2017 14:46:35 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" target="_parent">m2html</a></strong> &copy; 2005</address>
</body>
</html>