<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of CreateBatch</title>
  <meta name="keywords" content="CreateBatch">
  <meta name="description" content="% studyinfo=CreateBatch(model,varargin)">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
  <script type="text/javascript">
    if (top.frames.length == 0) { top.location = "../index.html"; };
  </script>
</head>
<body>
<a name="_top"></a>
<!-- menu.html functions -->
<h1>CreateBatch
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>% studyinfo=CreateBatch(model,varargin)</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function studyinfo=CreateBatch(base_model,modifications_set,varargin) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment">% studyinfo=CreateBatch(model,varargin)
 Purpose: create and submit jobs to run sets of simulations or analyses.
 Inputs:
   - DynaSim model (see GenerateModel)
   - modifications_set (as returned by Vary2Modifications())
   options:
     'compile_flag'  : whether to compile simulation using coder instead of 
                     interpreting Matlab {0 or 1} (default: 0)
     'verbose_flag'  : whether to display informative messages/logs (default: 0)
     'overwrite_flag': whether to overwrite existing data files {0 or 1} (default: 0)
   options for cluster computing:
     'sims_per_job'  : number of simulations to run per cluster job (default: 1)
     'memory_limit'  : memory to allocate per cluster job (default: '8G')
     'batch_dir'     : where to save job scripts
   options for parallel computing: (requires Parallel Computing Toolbox)
     'parallel_flag' : whether to use parfor to run simulations {0 or 1} (default: 0)
     'num_cores'     : number of cores to specify in the parallel pool
     *note: parallel computing has been disabled for debugging...

 Outputs:
   - DynaSim studyinfo (see CheckStudyinfo for schema info)
 
 See also: <a href="GenerateModel.html" class="code" title="function [model,name_map]=GenerateModel(specification,varargin)">GenerateModel</a>, <a href="SimulateModel.html" class="code" title="function [data,studyinfo]=SimulateModel(model,varargin)">SimulateModel</a>, <a href="CheckStudyinfo.html" class="code" title="function studyinfo=CheckStudyinfo(studyinfo,varargin)">CheckStudyinfo</a>, <a href="Vary2Modifications.html" class="code" title="function modifications_set = Vary2Modifications(vary,model)">Vary2Modifications</a></pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="CheckOptions.html" class="code" title="function parms = CheckOptions(options, options_schema, strict)">CheckOptions</a>	CHECKOPTIONS - organize key/value pairs in structure with default or user-supplied values according to a schema</li><li><a href="CheckStudyinfo.html" class="code" title="function studyinfo=CheckStudyinfo(studyinfo,varargin)">CheckStudyinfo</a>	CHECKSTUDYINFO - Standardize studyinfo structure and auto-populate missing fields</li><li><a href="GetSolveFile.html" class="code" title="function solve_file = GetSolveFile(model,studyinfo,varargin)">GetSolveFile</a>	% solve_file = GetSolveFile(model,studyinfo,options)</li><li><a href="LocateModelFiles.html" class="code" title="function [paths,files]=LocateModelFiles(input)">LocateModelFiles</a>	% [paths,files]=LocateModelFiles(input)</li><li><a href="MonitorStudy.html" class="code" title="function [studyinfo,study_status]=MonitorStudy(studyinfo,varargin)">MonitorStudy</a>	[studyinfo,status]=MonitorStudy(studyinfo,key/value options)</li><li><a href="SetupStudy.html" class="code" title="function [studyinfo,options]=SetupStudy(base_model,varargin)">SetupStudy</a>	Purpose:</li><li><a href="StudyinfoIO.html" class="code" title="function studyinfo=StudyinfoIO(studyinfo,study_file,id,verbose_flag)">StudyinfoIO</a>	Usage:</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="SimulateModel.html" class="code" title="function [data,studyinfo]=SimulateModel(model,varargin)">SimulateModel</a>	% data=SimulateModel(model,'option',value,...)</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="#_sub1" class="code">function WriteSimJob(sim_ids,job_file)</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function studyinfo=CreateBatch(base_model,modifications_set,varargin)</a>
0002 <span class="comment">%% studyinfo=CreateBatch(model,varargin)</span>
0003 <span class="comment">% Purpose: create and submit jobs to run sets of simulations or analyses.</span>
0004 <span class="comment">% Inputs:</span>
0005 <span class="comment">%   - DynaSim model (see GenerateModel)</span>
0006 <span class="comment">%   - modifications_set (as returned by Vary2Modifications())</span>
0007 <span class="comment">%   options:</span>
0008 <span class="comment">%     'compile_flag'  : whether to compile simulation using coder instead of</span>
0009 <span class="comment">%                     interpreting Matlab {0 or 1} (default: 0)</span>
0010 <span class="comment">%     'verbose_flag'  : whether to display informative messages/logs (default: 0)</span>
0011 <span class="comment">%     'overwrite_flag': whether to overwrite existing data files {0 or 1} (default: 0)</span>
0012 <span class="comment">%   options for cluster computing:</span>
0013 <span class="comment">%     'sims_per_job'  : number of simulations to run per cluster job (default: 1)</span>
0014 <span class="comment">%     'memory_limit'  : memory to allocate per cluster job (default: '8G')</span>
0015 <span class="comment">%     'batch_dir'     : where to save job scripts</span>
0016 <span class="comment">%   options for parallel computing: (requires Parallel Computing Toolbox)</span>
0017 <span class="comment">%     'parallel_flag' : whether to use parfor to run simulations {0 or 1} (default: 0)</span>
0018 <span class="comment">%     'num_cores'     : number of cores to specify in the parallel pool</span>
0019 <span class="comment">%     *note: parallel computing has been disabled for debugging...</span>
0020 <span class="comment">%</span>
0021 <span class="comment">% Outputs:</span>
0022 <span class="comment">%   - DynaSim studyinfo (see CheckStudyinfo for schema info)</span>
0023 <span class="comment">%</span>
0024 <span class="comment">% See also: GenerateModel, SimulateModel, CheckStudyinfo, Vary2Modifications</span>
0025 
0026 <span class="comment">% dependencies: SetupStudy, UpdateStudy</span>
0027 
0028 <span class="comment">% check inputs</span>
0029 options=<a href="CheckOptions.html" class="code" title="function parms = CheckOptions(options, options_schema, strict)">CheckOptions</a>(varargin,{<span class="keyword">...</span>
0030   <span class="string">'compile_flag'</span>,0,{0,1},<span class="keyword">...</span>
0031   <span class="string">'parallel_flag'</span>,0,{0,1},<span class="keyword">...</span>
0032   <span class="string">'num_cores'</span>,4,[],<span class="keyword">...</span><span class="comment"> % # cores for parallel processing (SCC supports 1-12)</span>
0033   <span class="string">'sims_per_job'</span>,1,[],<span class="keyword">...</span><span class="comment"> % how many sims to run per cluster job</span>
0034   <span class="string">'memory_limit'</span>,<span class="string">'8G'</span>,[],<span class="keyword">...</span><span class="comment"> % how much memory to allocate per cluster job</span>
0035   <span class="string">'batch_dir'</span>,[],[],<span class="keyword">...</span>
0036   <span class="string">'simulator_options'</span>,[],[],<span class="keyword">...</span>
0037   <span class="string">'verbose_flag'</span>,0,{0,1},<span class="keyword">...</span>
0038   <span class="string">'overwrite_flag'</span>,0,{0,1},<span class="keyword">...</span>
0039   <span class="string">'process_id'</span>,[],[],<span class="keyword">...</span><span class="comment"> % process identifier for loading studyinfo if necessary</span>
0040   },false);
0041 
0042 <span class="comment">% Set up studyinfo structure, study directory and output file names</span>
0043 <span class="comment">%[studyinfo,options.simulator_options]=SetupStudy(base_model,modifications_set,options.simulator_options);</span>
0044 [studyinfo,options.simulator_options]=<a href="SetupStudy.html" class="code" title="function [studyinfo,options]=SetupStudy(base_model,varargin)">SetupStudy</a>(base_model,<span class="string">'modifications_set'</span>,modifications_set,<span class="string">'simulator_options'</span>,options.simulator_options,<span class="string">'process_id'</span>,options.process_id);
0045 study_file=fullfile(studyinfo.study_dir,<span class="string">'studyinfo.mat'</span>);
0046 num_simulations=length(modifications_set);
0047 
0048 <span class="comment">% check whether study has already completed</span>
0049 <span class="comment">% if options.overwrite_flag==0</span>
0050   [~,s]=<a href="MonitorStudy.html" class="code" title="function [studyinfo,study_status]=MonitorStudy(studyinfo,varargin)">MonitorStudy</a>(studyinfo.study_dir,<span class="string">'verbose_flag'</span>,0,<span class="string">'process_id'</span>,options.process_id);
0051   <span class="keyword">if</span> s==1 <span class="comment">% study finished</span>
0052     <span class="keyword">if</span> options.verbose_flag
0053       fprintf(<span class="string">'Study already finished. Not creating new batch.\n'</span>);
0054     <span class="keyword">end</span>
0055     studyinfo=<a href="CheckStudyinfo.html" class="code" title="function studyinfo=CheckStudyinfo(studyinfo,varargin)">CheckStudyinfo</a>(studyinfo.study_dir,<span class="string">'process_id'</span>,options.process_id);
0056     <span class="keyword">return</span>;
0057   <span class="keyword">end</span>
0058 <span class="comment">% end</span>
0059 
0060 <span class="keyword">if</span> isa(options.simulator_options.experiment,<span class="string">'function_handle'</span>) &amp;&amp; options.compile_flag
0061   options.compile_flag=0;
0062   options.simulator_options.compile_flag=0;
0063   fprintf(<span class="string">'WARNING: solver compilation is not available for experiments run on the cluster.\n'</span>);
0064 <span class="keyword">end</span>
0065 
0066 <span class="comment">% create base solve_file (m- or MEX-file)</span>
0067 solve_file=<a href="GetSolveFile.html" class="code" title="function solve_file = GetSolveFile(model,studyinfo,varargin)">GetSolveFile</a>(base_model,studyinfo,options.simulator_options);
0068 
0069 <span class="comment">% add appropriate MEX extension if compiled</span>
0070 <span class="comment">% note: the extension depends on whether a 32-bit or 64-bit machine is used</span>
0071 <span class="keyword">if</span> options.compile_flag
0072   <span class="comment">% get directory where solve_file is located and the file name</span>
0073   [fpath,fname]=fileparts(solve_file);
0074   <span class="comment">% get list of files in solve directory</span>
0075   D=dir(fpath);
0076   <span class="comment">% get extension of files with matching names</span>
0077   tmp=regexp({D.name},[fname <span class="string">'\.(\w+)$'</span>],<span class="string">'tokens'</span>,<span class="string">'once'</span>);
0078   tmp=unique([tmp{:}]);
0079   <span class="comment">% append extension to solve_file</span>
0080   full_solve_file=[solve_file <span class="string">'.'</span> tmp{1}];
0081   <span class="comment">% remove '_mex' suffix from solve_file for compatibility with GetSolveFile()</span>
0082   solve_file=regexp(solve_file,<span class="string">'(.+)_mex$'</span>,<span class="string">'tokens'</span>,<span class="string">'once'</span>);
0083   solve_file=solve_file{1};
0084 <span class="keyword">else</span>
0085   full_solve_file=solve_file;
0086 <span class="keyword">end</span>
0087 studyinfo.base_solve_file=solve_file;
0088 
0089 <span class="comment">% set name of batch_dir for this study</span>
0090 <span class="comment">% get study-specific timestamp</span>
0091 timestamp=datestr(studyinfo.study_id,<span class="string">'yyyymmddHHMMSS'</span>);
0092 <span class="comment">% get home directory of the current user</span>
0093 [o,home]=system(<span class="string">'echo $HOME'</span>);
0094 <span class="comment">% create batch directory</span>
0095 [study_dir_path,study_dir_name,study_dir_suffix]=fileparts(studyinfo.study_dir);
0096 study_dir_name=[study_dir_name study_dir_suffix];
0097 batch_dir = fullfile(strtrim(home),<span class="string">'batchdirs'</span>,study_dir_name);
0098 <span class="comment">%batch_dir = fullfile(strtrim(home),'batchdirs',['Batch' timestamp]);</span>
0099 
0100 <span class="keyword">if</span> options.verbose_flag
0101   fprintf(<span class="string">'PREPARING BATCH:\n'</span>);
0102 <span class="keyword">end</span>
0103 
0104 <span class="comment">% create batch_dir to hold m-file jobs and more for this study</span>
0105 <span class="keyword">if</span> ~exist(batch_dir,<span class="string">'dir'</span>)
0106   <span class="keyword">if</span> options.verbose_flag
0107     fprintf(<span class="string">'creating batch jobs directory: %s\n'</span>,batch_dir);
0108   <span class="keyword">end</span>
0109   mkdir(batch_dir);
0110 <span class="keyword">end</span>
0111 <span class="comment">% copy study_file to batchdir</span>
0112 [success,msg]=copyfile(study_file,batch_dir);
0113 <span class="keyword">if</span> ~success, error(msg); <span class="keyword">end</span>
0114 
0115 <span class="comment">% locate DynaSim toolbox</span>
0116 dynasim_path=fileparts(fileparts(which(mfilename))); <span class="comment">% root is one level up from directory containing this function</span>
0117 dynasim_functions=fullfile(dynasim_path,<span class="string">'functions'</span>);
0118 <span class="comment">% locate mechanism files</span>
0119 [mech_paths,mech_files]=<a href="LocateModelFiles.html" class="code" title="function [paths,files]=LocateModelFiles(input)">LocateModelFiles</a>(base_model);
0120 
0121 <span class="comment">% add paths to studyinfo structure</span>
0122 studyinfo.paths.dynasim_functions=dynasim_path;
0123 studyinfo.paths.mechanisms=mech_paths;
0124 studyinfo.paths.batch_dir=batch_dir;
0125 
0126 <span class="comment">% edit simulator_options so that subsequent single simulations do not create further batches</span>
0127 options.simulator_options.parallel_flag=0;
0128 options.simulator_options.cluster_flag=0;
0129 options.simulator_options.verbose_flag=1; <span class="comment">% turn on verbose for cluster logs (stdout)</span>
0130 
0131 <span class="comment">% create jobs (k)</span>
0132 jobs={};
0133 skip_sims=[];
0134 sim_cnt=0;
0135 num_jobs=ceil(num_simulations/options.sims_per_job);
0136 <span class="keyword">if</span> options.verbose_flag
0137   fprintf(<span class="string">'creating %g cluster jobs in batch directory for %g simulations...\n'</span>,num_jobs,num_simulations);
0138 <span class="keyword">end</span>
0139 <span class="keyword">for</span> k=1:num_jobs
0140   job_file=fullfile(batch_dir,sprintf(<span class="string">'sim_job%g.m'</span>,k));
0141   sim_ids=sim_cnt+(1:options.sims_per_job);
0142   sim_ids=sim_ids(sim_ids&lt;=num_simulations);
0143   sim_cnt=sim_cnt+options.sims_per_job;
0144   <span class="comment">% only run simulations if data_file does not exist (unless overwrite_flag=1)</span>
0145   proc_sims=[]; <span class="comment">% simulations to run in this job</span>
0146   <span class="keyword">for</span> j=1:length(sim_ids)
0147     <span class="comment">%if ~exist(studyinfo.simulations(sim_ids(j)).data_file,'file') || options.overwrite_flag</span>
0148     <span class="keyword">if</span> (options.simulator_options.save_data_flag &amp;&amp; ~exist(studyinfo.simulations(sim_ids(j)).data_file,<span class="string">'file'</span>)) || <span class="keyword">...</span>
0149        (options.simulator_options.save_results_flag &amp;&amp; ~exist(studyinfo.simulations(sim_ids(j)).result_files{1},<span class="string">'file'</span>)) || <span class="keyword">...</span>
0150        options.overwrite_flag
0151       proc_sims=[proc_sims sim_ids(j)];
0152     <span class="keyword">end</span>
0153   <span class="keyword">end</span>
0154   <span class="keyword">if</span> isempty(proc_sims)
0155     skip_sims=[skip_sims sim_ids];
0156     <span class="keyword">continue</span>; <span class="comment">% skip this job</span>
0157   <span class="keyword">else</span>
0158     skip_sims=[skip_sims setdiff(sim_ids,proc_sims)];
0159   <span class="keyword">end</span>
0160   <a href="#_sub1" class="code" title="subfunction WriteSimJob(sim_ids,job_file)">WriteSimJob</a>(proc_sims,job_file); <span class="comment">% create job script</span>
0161   jobs{end+1}=job_file;
0162   <span class="comment">% add job_file to studyinfo</span>
0163   <span class="keyword">for</span> j=1:length(proc_sims)
0164     studyinfo.simulations(proc_sims(j)).job_file=job_file;
0165   <span class="keyword">end</span>
0166 <span class="keyword">end</span>
0167 
0168 <span class="comment">% todo: have job scripts create lock for each sim; then, check for lock</span>
0169 <span class="comment">% file in this function and skip simulations if they're already running</span>
0170 <span class="comment">% (similar to skipping if data_file already exists).</span>
0171 
0172 <span class="comment">% exit if there are no simulations to run</span>
0173 <span class="keyword">if</span> numel(skip_sims)==num_simulations
0174   <span class="keyword">if</span> options.verbose_flag
0175     fprintf(<span class="string">'data exists for all simulations in study. nothing to do.\n'</span>);
0176   <span class="keyword">end</span>
0177   <span class="keyword">return</span>;
0178 <span class="keyword">end</span>
0179 
0180 <span class="comment">% create scriptlist.txt (list of jobs)</span>
0181 scriptlist_file=fullfile(batch_dir,<span class="string">'scriptlist.txt'</span>);
0182 <span class="keyword">if</span> options.verbose_flag
0183   fprintf(<span class="string">'creating file listing jobs in batch directory: %s\n'</span>,scriptlist_file);
0184 <span class="keyword">end</span>
0185 flist=fopen(scriptlist_file,<span class="string">'wt'</span>);
0186 <span class="keyword">for</span> j=1:length(jobs)
0187   [~,fn]=fileparts(jobs{j});
0188   fprintf(flist,<span class="string">'%s\n'</span>,fn);
0189 <span class="keyword">end</span>
0190 fclose(flist);
0191 
0192 <span class="comment">% copy solve_file to each sim-specific solve sub-directory: &lt;study_dir&gt;/solve/sim&lt;k&gt;/&lt;solve_file&gt;</span>
0193 <span class="comment">% and set sim-specific studyinfo</span>
0194 <span class="keyword">if</span> options.verbose_flag
0195   fprintf(<span class="string">'creating distinct solver sub-directories for %g simulations...\n'</span>,num_simulations);
0196 <span class="keyword">end</span>
0197 <span class="comment">%[solve_path,solve_name,solve_ext]=fileparts(solve_file);</span>
0198 [solve_path,solve_name,solve_ext]=fileparts(full_solve_file);
0199 <span class="comment">% prepare studyinfo with simulation-specific metadata</span>
0200 <span class="keyword">for</span> sim=1:num_simulations
0201   <span class="keyword">if</span> ismember(sim,skip_sims)
0202     <span class="keyword">continue</span>; <span class="comment">% do nothing with this simulation</span>
0203   <span class="keyword">end</span>
0204   this_solve_path=fullfile(solve_path,[<span class="string">'sim'</span> num2str(sim)]);
0205   <span class="keyword">if</span> ~exist(this_solve_path,<span class="string">'dir'</span>)
0206     <span class="comment">%if options.verbose_flag</span>
0207     <span class="comment">%  fprintf('creating solver sub-directory for simulation #%g: %s\n',sim,this_solve_path);</span>
0208     <span class="comment">%end</span>
0209     mkdir(this_solve_path);
0210   <span class="keyword">end</span>
0211   [success,msg]=copyfile(full_solve_file,this_solve_path); <span class="comment">% creates solve sub-directory and copies the base solve file to it</span>
0212   <span class="keyword">if</span> ~success, error(msg); <span class="keyword">end</span>
0213   <span class="comment">% set studyinfo solve_file to use for this simulation</span>
0214   this_solve_file=fullfile(this_solve_path,[solve_name solve_ext]);
0215   studyinfo.simulations(sim).solve_file=this_solve_file;
0216   studyinfo.simulations(sim).batch_dir=batch_dir;
0217   studyinfo.simulations(sim).simulator_options=options.simulator_options;
0218   <span class="comment">% set solve_file for this simulation (will be passed to SimulateModel as an option)</span>
0219   <span class="keyword">if</span> isa(options.simulator_options.experiment,<span class="string">'function_handle'</span>)
0220     studyinfo.simulations(sim).simulator_options.solve_file=[];
0221   <span class="keyword">else</span>
0222     studyinfo.simulations(sim).simulator_options.solve_file=this_solve_file;
0223   <span class="keyword">end</span>
0224   <span class="comment">% set vary to [] to avoid each sim expanding to a new set</span>
0225   studyinfo.simulations(sim).simulator_options.vary=[];
0226   studyinfo.simulations(sim).simulator_options.sim_id=studyinfo.simulations(sim).sim_id;
0227   studyinfo.simulations(sim).error_log=<span class="string">''</span>;
0228   <span class="comment">% copy studyinfo to batch_dir for each simulation</span>
0229   <span class="comment">%this_study_file=fullfile(batch_dir,sprintf('studyinfo_%g.mat',sim));</span>
0230   <span class="comment">%save(this_study_file,'studyinfo');</span>
0231 <span class="keyword">end</span>
0232 <span class="comment">% copy studyinfo file to batch_dir for each simulation</span>
0233 <span class="keyword">for</span> sim=1:num_simulations
0234   this_study_file=fullfile(batch_dir,sprintf(<span class="string">'studyinfo_%g.mat'</span>,sim));
0235   <span class="keyword">if</span> sim==1
0236     save(this_study_file,<span class="string">'studyinfo'</span>);
0237     first_study_file=this_study_file;
0238   <span class="keyword">else</span>
0239     <span class="comment">% use copyfile() after saving first b/c &gt;10x faster than save()</span>
0240     [success,msg]=copyfile(first_study_file,this_study_file);
0241     <span class="keyword">if</span> ~success, error(msg); <span class="keyword">end</span>
0242   <span class="keyword">end</span>
0243 <span class="keyword">end</span>
0244 
0245 <span class="comment">% update studyinfo on disk</span>
0246 <a href="StudyinfoIO.html" class="code" title="function studyinfo=StudyinfoIO(studyinfo,study_file,id,verbose_flag)">StudyinfoIO</a>(studyinfo,study_file,options.simulator_options.sim_id,options.verbose_flag);
0247 
0248 <span class="comment">% todo: remove old lock files ..</span>
0249 
0250 <span class="comment">% check for qsub on system</span>
0251 [status,result]=system(<span class="string">'which qsub'</span>);
0252 <span class="keyword">if</span> isempty(result)
0253   [jnk,host] = system(<span class="string">'hostname'</span>);
0254   fprintf(<span class="string">'qsub not found on host (%s).\n'</span>,strtrim(host));
0255   fprintf(<span class="string">'Jobs NOT submitted to cluster queue.\n'</span>);
0256 <span class="keyword">else</span> <span class="comment">% on cluster with qsub</span>
0257   <span class="comment">% submit jobs (e.g., qmatjobs_memlimit batch_dir 32G)</span>
0258   <span class="comment">% check status of study</span>
0259   [~,s]=<a href="MonitorStudy.html" class="code" title="function [studyinfo,study_status]=MonitorStudy(studyinfo,varargin)">MonitorStudy</a>(studyinfo.study_dir,<span class="string">'verbose_flag'</span>,0);
0260   <span class="keyword">if</span> s~=1 <span class="comment">% study not finished</span>
0261     <span class="comment">% submit jobs using shell script</span>
0262     [batch_dir_path,batch_dir_name,batch_suffix]=fileparts(batch_dir);
0263     batch_dir_name=[batch_dir_name batch_suffix];
0264     <span class="keyword">if</span> options.parallel_flag
0265       cmd=sprintf(<span class="string">'qmatjobs_pct %s %s %g'</span>,batch_dir_name,options.memory_limit,options.num_cores);
0266       <span class="comment">%status=system('which qmatjobs_pct');</span>
0267     <span class="keyword">else</span>
0268       cmd=sprintf(<span class="string">'qmatjobs_memlimit %s %s'</span>,batch_dir_name,options.memory_limit);
0269       <span class="comment">%status=system('which qmatjobs_memlimit');</span>
0270     <span class="keyword">end</span>
0271     <span class="comment">% add shell script to linux path if not already there</span>
0272     <span class="comment">%if status~=0</span>
0273       setenv(<span class="string">'PATH'</span>, [getenv(<span class="string">'PATH'</span>) <span class="string">':'</span> dynasim_functions]);
0274     <span class="comment">%end</span>
0275     <span class="keyword">if</span> options.verbose_flag
0276       fprintf(<span class="string">'submitting cluster jobs with shell command: &quot;%s&quot;\n'</span>,cmd);
0277     <span class="keyword">end</span>
0278     [status,result]=system(cmd);
0279     <span class="keyword">if</span> status
0280       fprintf(<span class="string">'submit command failed: &quot;%s&quot;\n'</span>,cmd);
0281       disp(result);
0282       <span class="keyword">return</span>;
0283     <span class="keyword">end</span>
0284     <span class="comment">%if options.verbose_flag</span>
0285       <span class="comment">%fprintf('%g jobs successfully submitted!\ntip: use MonitorStudy(''%s'') or MonitorStudy(studyinfo) to track status of cluster jobs.\n',num_jobs,studyinfo.study_dir);</span>
0286       fprintf(<span class="string">'%g jobs successfully submitted!\n'</span>,length(jobs));
0287     <span class="comment">%end</span>
0288   <span class="keyword">elseif</span> s==1 <span class="comment">% study is finished</span>
0289     <span class="keyword">if</span> options.verbose_flag
0290       fprintf(<span class="string">'study already finished. not submitting jobs.\n'</span>);
0291     <span class="keyword">end</span>
0292   <span class="keyword">end</span>
0293 <span class="keyword">end</span>
0294 
0295 <span class="comment">%% NESTED FUNCTIONS</span>
0296   <a name="_sub1" href="#_subfunctions" class="code">function WriteSimJob(sim_ids,job_file)</a>
0297     <span class="comment">% purpose: write m-file to job_file to run simulations of sim_ids</span>
0298     <span class="comment">% create job file</span>
0299     fjob=fopen(job_file,<span class="string">'wt'</span>);
0300     <span class="comment">% load studyinfo using helper function to avoid busy file errors</span>
0301     <span class="comment">%fprintf(fjob,'studyinfo=CheckStudyinfo(''%s'',''process_id'',%g);\n',study_file,sim_ids(1));</span>
0302     <span class="comment">%fprintf(fjob,'load(''%s'',''studyinfo'');\n',study_file);</span>
0303     <span class="comment">% set IDs of simulations to run</span>
0304     fprintf(fjob,<span class="string">'SimIDs=[%s]\n'</span>,num2str(sim_ids));
0305     <span class="comment">% loop over and run simulations in this job</span>
0306     <span class="keyword">if</span> options.parallel_flag
0307       <span class="comment">% set parallel computing options</span>
0308       <span class="comment">%fprintf(fjob,'started=0;\npool=gcp(''nocreate'');\n');</span>
0309       <span class="comment">%fprintf(fjob,'if isempty(pool), parpool(%g); started=1; end\n',options.num_cores);</span>
0310       fprintf(fjob,<span class="string">'c=parcluster;\nsaveAsProfile(c,''local_%g'');\nparpool(c,%g);\n'</span>,k,options.num_cores);
0311       <span class="comment">% use parfor loop</span>
0312       fprintf(fjob,<span class="string">'parfor s=1:length(SimIDs)\n'</span>);
0313     <span class="keyword">else</span>
0314       <span class="comment">% use for loop</span>
0315       fprintf(fjob,<span class="string">'for s=1:length(SimIDs)\n'</span>);
0316     <span class="keyword">end</span>
0317     fprintf(fjob,<span class="string">'\tSimID=SimIDs(s);\n'</span>);
0318     <span class="comment">% each job should have try-catch to capture studyinfo.simulations(k).error_log</span>
0319     fprintf(fjob,<span class="string">'\ttry\n'</span>);
0320     <span class="comment">% load studyinfo for this simulation</span>
0321     fprintf(fjob,<span class="string">'\t\tload(fullfile(''%s'',sprintf(''studyinfo_%%g.mat'',SimID)),''studyinfo'');\n'</span>,batch_dir);
0322     <span class="comment">% compare paths between compute machine and studyinfo startup</span>
0323     fprintf(fjob,<span class="string">'\t\t[valid,message]=CheckHostPaths(studyinfo);\n'</span>);
0324     fprintf(fjob,<span class="string">'\t\tif ~valid\n\t\t  lasterr(message);\n\t\t  for s=1:length(SimIDs), UpdateStudy(studyinfo.study_dir,''sim_id'',SimIDs(s),''status'',''failed''); end\n\t\t  continue;\n\t\tend\n'</span>);
0325     <span class="comment">% simulate model with proper modifications and options</span>
0326     fprintf(fjob,<span class="string">'\t\tsiminfo=studyinfo.simulations(SimID);\n'</span>);
0327     fprintf(fjob,<span class="string">'\t\toptions=rmfield(siminfo.simulator_options,{''modifications'',''studyinfo'',''analysis_functions'',''plot_functions'',''sim_id''});\n'</span>);
0328     fprintf(fjob,<span class="string">'\t\tkeyvals=Options2Keyval(options);\n'</span>);
0329     fprintf(fjob,<span class="string">'\t\tfprintf(''-----------------------------------------------------\\n'');\n'</span>);
0330     fprintf(fjob,<span class="string">'\t\tfprintf(''Processing simulation %%g (%%g of %%g in this job)...\\n'',SimID,s,length(SimIDs));\n'</span>);
0331     fprintf(fjob,<span class="string">'\t\tfprintf(''-----------------------------------------------------\\n'');\n'</span>);
0332     fprintf(fjob,<span class="string">'\t\tdata=SimulateModel(studyinfo.base_model,''modifications'',siminfo.modifications,''studyinfo'',studyinfo,''sim_id'',SimID,keyvals{:});\n'</span>);    
0333     fprintf(fjob,<span class="string">'\t\tfor i=1:length(siminfo.result_functions)\n'</span>);
0334     fprintf(fjob,<span class="string">'\t\t\tAnalyzeData(data,siminfo.result_functions{i},''result_file'',siminfo.result_files{i},''save_data_flag'',1,siminfo.result_options{i}{:});\n'</span>);
0335     fprintf(fjob,<span class="string">'\t\tend\n'</span>);
0336     <span class="comment">% add error handling</span>
0337     fprintf(fjob,<span class="string">'\tcatch err\n'</span>);
0338     <span class="comment">%fprintf(fjob,'\t\ttry delete(fullfile(studyinfo.study_dir,[''.locked_'' num2str(SimID)])); end\n');</span>
0339     fprintf(fjob,<span class="string">'\t\tDisplayError(err);\n'</span>);
0340     fprintf(fjob,<span class="string">'\tend\n'</span>);
0341     <span class="comment">% end loop over simulations in this job</span>
0342     fprintf(fjob,<span class="string">'end\n'</span>);
0343     <span class="keyword">if</span> options.parallel_flag
0344       <span class="comment">%fprintf(fjob,'if started, delete(gcp); end\n');</span>
0345       fprintf(fjob,<span class="string">'delete(gcp)\n'</span>);
0346     <span class="keyword">end</span>
0347     <span class="comment">% exit script</span>
0348     [status,result]=system(<span class="string">'which qsub'</span>);
0349     <span class="keyword">if</span> ~isempty(result) <span class="comment">% on cluster</span>
0350       fprintf(fjob,<span class="string">'exit\n'</span>);
0351     <span class="keyword">end</span>
0352     <span class="comment">% close job file</span>
0353     fclose(fjob);    
0354   <span class="keyword">end</span>
0355 
0356 <span class="keyword">end</span>
0357 
0358 <span class="comment">% -------------------</span>
0359 <span class="comment">% in CreateBatch():</span>
0360 <span class="comment">% -------------------</span>
0361 <span class="comment">% create solve_file</span>
0362 <span class="comment">% for each sim k</span>
0363 <span class="comment">%   copy to this_solve_file = /solve/sim&lt;k&gt;/solve_file</span>
0364 <span class="comment">%   set studyinfo.simulations(k).solve_file=this_solve_file</span>
0365 <span class="comment">% ...</span>
0366 <span class="comment">% in sim job.m:</span>
0367 <span class="comment">% SimulateModel(model{k},'solve_file',solve_file{k},...)</span>
0368 <span class="comment">% where solve_file{k}=studyinfo.simulations(k).solve_file</span>
0369</pre></div>
<hr><address>Generated on Fri 24-Feb-2017 14:46:35 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" target="_parent">m2html</a></strong> &copy; 2005</address>
</body>
</html>